<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reembolso Geral</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/monday-sdk-js@0.5.6/dist/main.js"></script>
</head>
<body class="min-h-screen bg-gray-50 p-6">
  <div class="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow">
    <h1 class="text-2xl font-bold mb-6">Reembolso Geral</h1>

    <form id="form-reembolso" class="space-y-5">
      <div>
        <label class="block text-sm font-medium mb-1">Descrição do Gasto *</label>
        <input id="descricao" type="text" maxlength="255" required class="w-full border rounded p-2">
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Pessoa *</label>
        <select id="pessoa" required class="w-full border rounded p-2"></select>
        <p class="text-xs text-gray-500 mt-1">Usuários ativos do Monday</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Data do gasto *</label>
          <input id="data_gasto" type="date" required class="w-full border rounded p-2">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Valor</label>
          <input id="valor" type="number" step="0.01" class="w-full border rounded p-2">
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Evento *</label>
        <select id="evento" required class="w-full border rounded p-2"></select>
        <p class="text-xs text-gray-500 mt-1">Itens dos boards conectados à coluna Evento</p>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Link (opcional)</label>
        <input id="link" type="url" placeholder="https://..." class="w-full border rounded p-2">
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Comprovante</label>
        <input id="comprovante" type="file" accept="image/*,application/pdf" class="w-full border rounded p-2">
        <p class="text-xs text-gray-500 mt-1">Aceita imagens ou PDF</p>
      </div>

      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">
        Enviar
      </button>
    </form>

    <p id="status" class="mt-4 text-sm"></p>
  </div>

<script>
  const COL_PESSOA = "person";
  const COL_DATA_GASTO = "date4";
  const COL_VALOR = "numbers";
  const COL_EVENTO = "connect_boards__1";
  const COL_LINK = "link";
  const COL_COMPROVANTE = "files";

  const monday = mondaySdk();

  let currentBoardId = null;

  // --- util: aguarda token e contexto antes de qualquer chamada ---
  async function waitForMondayReady() {
    // 1) token da sessão
    const tokenRes = await monday.get("sessionToken");
    if (!tokenRes || !tokenRes.data) throw new Error("Não foi possível obter sessionToken.");
    monday.setToken(tokenRes.data);

    // 2) contexto do board
    const ctx = await new Promise(resolve => {
      monday.listen("context", res => resolve(res));
  });
    if (!ctx || !ctx.data || !ctx.data.boardId) throw new Error("Não foi possível obter boardId do contexto.");
    currentBoardId = ctx.data.boardId;
  }

  function setStatus(msg, ok = true) {
    const el = document.getElementById("status");
    el.textContent = msg;
    el.className = ok ? "mt-4 text-sm text-green-700" : "mt-4 text-sm text-red-700";
  }

  function escapeForGraphQL(jsonObj) {
    return JSON.stringify(jsonObj).replace(/"/g, '\\"');
  }

  async function loadUsers() {
    const res = await monday.api(`
    query {
      users(kind: non_guests, limit: 500) {
        id
        name
        enabled
      }
    }
  `);
    if (!res || !res.data) throw new Error("Falha ao carregar usuários (sem data).");
    return res.data.users.filter(u => u.enabled);
  }

  async function getConnectedBoardIds(boardId, columnId) {
    const res = await monday.api(`
    query {
      boards(ids: [${boardId}]) {
        columns(ids: ["${columnId}"]) { settings_str }
      }
    }
  `);
    if (!res || !res.data) throw new Error("Falha ao carregar settings da coluna Evento.");
    const settings = JSON.parse(res.data.boards[0].columns[0].settings_str || "{}");
    const ids = settings.boardIds || settings.boardIdsStr || [];
    return ids.map(Number).filter(Boolean);
  }

  async function populatePessoaSelect() {
    const users = await loadUsers();
    const sel = document.getElementById("pessoa");
    sel.innerHTML = "";
    users.forEach(u => {
      const opt = document.createElement("option");
      opt.value = u.id;
      opt.textContent = u.name;
      sel.appendChild(opt);
    });
  }

  async function populateEventoSelectFromConnectedBoards(boardId, colEvento) {
    const sel = document.getElementById("evento");
    sel.innerHTML = "";

    const connectedBoardIds = await getConnectedBoardIds(boardId, colEvento);
    if (!connectedBoardIds.length) {
      setStatus("A coluna de Evento não está conectada a nenhum board.", false);
      return;
    }

    const results = await Promise.all(connectedBoardIds.map(id => monday.api(`
    query {
      boards(ids: [${id}]) {
        id
        name
        items_page(limit: 500) { items { id name } }
      }
    }
  `)));

    results.forEach(r => {
      const b = r.data.boards[0];
      const group = document.createElement("optgroup");
      group.label = `• ${b.name}`;
      document.getElementById("evento").appendChild(group);
      b.items_page.items.forEach(it => {
        const opt = document.createElement("option");
        opt.value = it.id;
        opt.textContent = it.name;
      group.appendChild(opt);
    });
    });
  }

  async function createReembolso(boardId, payload) {
    const columnValues = {
      [COL_PESSOA]: { personsAndTeams: [{ id: Number(payload.pessoaId), kind: "person" }] },
      [COL_DATA_GASTO]: { date: payload.dataGasto },
      [COL_VALOR]: payload.valor ? String(payload.valor) : "",
      [COL_EVENTO]: { linkedPulseIds: [{ linkedPulseId: Number(payload.eventoItemId) }] },
      ...(payload.link ? { [COL_LINK]: { url: payload.link, text: "Comprovante/Referência" } } : {})
    };

    const mutation = `
    mutation {
      create_item(
        board_id: ${boardId},
        item_name: "${payload.descricao.replace(/"/g, '\\"')}",
        column_values: "${escapeForGraphQL(columnValues)}"
      ) { id }
    }
  `;
    return monday.api(mutation);
  }

  async function uploadFileToColumn(itemId, file) {
    const token = (await monday.get("sessionToken")).data;
    const formData = new FormData();
    formData.append("query", `
    mutation addFile($file: File!) {
      add_file_to_column(item_id: ${itemId}, column_id: "${COL_COMPROVANTE}", file: $file) { id }
    }
  `);
    formData.append("variables[file]", file);

    const res = await fetch("https://api.monday.com/v2/file", {
      method: "POST",
      headers: { Authorization: token },
      body: formData
    });
    return res.json();
  }

  document.addEventListener("DOMContentLoaded", async () => {
    try {
      // Aguarda token + contexto ANTES de qualquer chamada
      await waitForMondayReady();

    await populatePessoaSelect();
      await populateEventoSelectFromConnectedBoards(currentBoardId, COL_EVENTO);

    document.getElementById("form-reembolso").addEventListener("submit", async (e) => {
      e.preventDefault();
      setStatus("Enviando...");

      const descricao = document.getElementById("descricao").value.trim();
      const pessoaId = document.getElementById("pessoa").value;
      const dataGasto = document.getElementById("data_gasto").value;
      const valor = document.getElementById("valor").value;
      const eventoItemId = document.getElementById("evento").value;
      const link = document.getElementById("link").value.trim();
      const file = document.getElementById("comprovante").files[0];

      if (!descricao || !pessoaId || !dataGasto || !eventoItemId) {
        setStatus("Preencha os campos obrigatórios.", false);
        return;
      }

      const res = await createReembolso(currentBoardId, { descricao, pessoaId, dataGasto, valor, eventoItemId, link });

      if (res.errors?.length) {
        setStatus("Erro: " + res.errors[0].message, false);
        console.error(res.errors);
        return;
      }
      if (!res.data?.create_item?.id) {
        setStatus("Erro: criação não retornou ID.", false);
        console.error(res);
        return;
      }

      const itemId = res.data.create_item.id;

      if (file) {
        const up = await uploadFileToColumn(itemId, file);
        if (up.errors?.length) {
          console.error("Erro upload:", up.errors[0].message);
          setStatus("Item criado, mas falhou ao anexar o comprovante.", false);
          return;
        }
      }

      setStatus(`Reembolso criado com sucesso! ID: ${itemId}`);
      e.target.reset();
    });
    } catch (err) {
      console.error(err);
      setStatus("Falha ao inicializar o app. Verifique permissões e contexto.", false);
    }
  });
</script>


</body>
</html>
